<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>조용한 초대</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="color-scheme" content="dark light" />
</head>
<body>
  <div class="center">
    <div class="card" id="card">
      <h1>조용한 초대</h1>
      <p id="intro">
        당신의 시간을 방해하고 싶지 않아요. 하지만, 저는 당신이 궁금해졌습니다.<br/>
        저는 대구에서 음악과 글을 쓰는 사람입니다. 가끔은 조용히, 가끔은 깊이,
        서로의 이야기를 나눌 수 있는 분을 찾습니다.
      </p>
      <div class="hr"></div>
      <p class="subtle">이 페이지는 <strong>단 한 번</strong>만 열립니다.</p>

      <p>
        <a href="#" id="cta" class="btn">대화를 이어가기</a>
      </p>

      <div class="footer">
        첫 화면이 다시 보이지 않는다면, <kbd>연락처</kbd>를 이미 보셨을 가능성이 높습니다.
      </div>
    </div>
  </div>

<script>
(function () {
  // 1) URL path에서 code 추출: /invite/{code}
  const path = window.location.pathname.replace(/\/+$/, '');
  const parts = path.split('/');
  const code = parts.length >= 3 ? parts[2] : null;

  // 2) 연락처(클릭 시 팝업) — 실제 값으로 바꿔서 배포
  const CONTACTS = [
    { label: 'Telegram', value: '@vanjichook' },
    { label: 'Signal',   value: 'signal.me/#p/8210XXXXXXX' },
    { label: 'Email',    value: 'inaekkum@gmail.com' }
  ];

  function showContacts() {
    const lines = CONTACTS.map(c => `${c.label}: ${c.value}`).join('\n');
    alert('연락처\n\n' + lines + '\n\n이 화면은 다시 열리지 않을 수 있습니다. 꼭 저장해 주세요.');
  }

  // 3) 서버로 1회 체크 요청
  async function checkOnce() {
    if (!code) {
      // 코드 없으면 만료 페이지로
      location.replace('/expired.html');
      return;
    }
    try {
      const resp = await fetch(`/api/visit?code=${encodeURIComponent(code)}`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' }
      });

      if (resp.status === 200) {
        // 첫 방문: 허용
        const data = await resp.json();
        if (data.allowed) {
          // 로컬 쿠키/스토리지도 세팅(보조적 방어)
          document.cookie = `invite_${code}=seen; path=/; SameSite=Lax; max-age=31536000`;
          localStorage.setItem(`invite_${code}`, 'seen');

          // CTA 클릭 시 연락처 노출
          document.getElementById('cta').addEventListener('click', function (e) {
            e.preventDefault();
            showContacts();
            // 연락처 노출 뒤, 새로고침/재방문 시 만료되도록 안내
          });
          return;
        }
      }

      // 이미 사용(410) 또는 기타
      location.replace('/expired.html');
    } catch (err) {
      // 에러 시 보수적으로 만료 처리
      location.replace('/expired.html');
    }
  }

  checkOnce();
})();
</script>
</body>
</html>
