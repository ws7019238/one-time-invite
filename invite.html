<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>조용한 초대</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="color-scheme" content="dark light" />
</head>
<body>
  <div class="center">
    <div class="card" id="card">
      <h1>조용한 초대</h1>
      <p id="intro">
        당신의 시간을 방해하고 싶지 않아요. 하지만, 당신이 무척 매력적인 사람이어서 용기를 내요.<br/>
        저는 대구에서 음악과 글을 쓰는 사람입니다. 가끔은 조용히, 가끔은 깊이,
        서로의 이야기를 나눌 수 있는 분을 찾습니다.
      </p>
      <div class="hr"></div>
      <p class="subtle">이 페이지는 <strong>단 한 번</strong>만 열립니다.</p>

      <p>
        <a href="#" id="cta" class="btn">대화를 이어가기</a>
      </p>

      <div class="footer">
        첫 화면이 다시 보이지 않는다면, <kbd>연락처</kbd>를 이미 보셨을 가능성이 높습니다.
      </div>
    </div>
  </div>

<script>
(function () {
  // URL path에서 code 추출: /invite/{code}
  const path = window.location.pathname.replace(/\/+$/, '');
  const parts = path.split('/');
  const code = parts.length >= 3 ? parts[2] : null;

  // 연락처 — 네 정보로 바꿔서 쓰기
  const CONTACTS = [
    { label: 'Telegram', value: '@happyforuss' },
    { label: 'Phone',   value: '010-9734-6974' },
  ];

  function showContacts() {
    const lines = CONTACTS.map(c => `${c.label}: ${c.value}`).join('\n');
    alert('연락처\n\n' + lines + '\n\n이 화면은 다시 열리지 않을 수 있습니다. 꼭 저장해 주세요.');
  }

  // ▼ 변경 핵심: 페이지 로드시엔 아무 것도 차단하지 않음
  //    '대화를 이어가기' 버튼을 눌렀을 때만 1회 소진 처리

  async function onContactClick(e) {
    e.preventDefault();
    if (!code) {
      // 코드가 없는 URL로 들어온 경우는 만료 페이지로
      location.replace('/expired.html');
      return;
    }

    // 중복 클릭 방지
    const btn = document.getElementById('cta');
    btn.setAttribute('disabled', 'true');

    try {
      // 첫 클릭 시에만 사용 처리(문서가 없으면 생성하고 허용, 있으면 410)
      const resp = await fetch(`/api/visit?code=${encodeURIComponent(code)}`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' }
      });

      if (resp.status === 200) {
        // 성공적으로 1회 소진 기록됨 → 연락처 보여주고 잠시 뒤 만료 페이지로
        showContacts();

        // 로컬 마커(보조 방어) — 같은 브라우저에서 재방문 시 만료 유도
        document.cookie = `invite_${code}=used; path=/; SameSite=Lax; max-age=31536000`;
        localStorage.setItem(`invite_${code}`, 'used');

        // 3초 뒤 만료 페이지로 이동
        setTimeout(() => {
          location.replace('/expired.html');
        }, 3000);
        return;
      }

      // 이미 사용된 코드(410) → 바로 만료
      if (resp.status === 410) {
        location.replace('/expired.html');
        return;
      }

      // 그 외 에러 → 보수적으로 만료 처리
      location.replace('/expired.html');
    } catch (err) {
      location.replace('/expired.html');
    }
  }

  // 버튼 핸들러 연결
  document.getElementById('cta').addEventListener('click', onContactClick);
})();
</script>
</body>
</html>
